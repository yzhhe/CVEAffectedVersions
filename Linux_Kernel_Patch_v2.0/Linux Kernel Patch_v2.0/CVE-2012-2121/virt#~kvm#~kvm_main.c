
@@ -873,12 +873,13 @@ int __kvm_set_memory_region(struct kvm *kvm,
 if (r)
 goto out_free;
 
-	/* map the pages in iommu page table */
+	/* map/unmap the pages in iommu page table */
 if (npages) {
 		r = kvm_iommu_map_pages(kvm, &new);
 if (r)
 goto out_free;
-	}
+	} else
+		kvm_iommu_unmap_pages(kvm, &old);
 
 	r = -ENOMEM;
 	slots = kmemdup(kvm->memslots, sizeof(struct kvm_memslots),

